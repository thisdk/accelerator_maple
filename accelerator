FROM alpine:latest

ARG KCPTUBE_VERSION="0.4.3"
ARG SHADOWSOCKS_VERSION="1.17.0"

ARG SHADOWSOCKS_URL="https://github.com/shadowsocks/shadowsocks-rust/releases/download/v${SHADOWSOCKS_VERSION}/shadowsocks-v${SHADOWSOCKS_VERSION}.x86_64-unknown-linux-musl.tar.xz"
ARG KCPTUBE_URL="https://github.com/cnbatch/kcptube/releases/download/v${KCPTUBE_VERSION}/kcptube-linux-musl-x64.tar.bz2"

RUN wget -O ~/kcptube.tar.bz2 ${KCPTUBE_URL} && tar -jxvf ~/kcptube.tar.bz2 kcptube -C /tmp/ && mv /tmp/kcptube /usr/bin/kcptube && rm -f ~/kcptube.tar.bz2
RUN wget -O ~/shadowsocks.tar.xz ${SHADOWSOCKS_URL} && tar -xvf ~/shadowsocks.tar.xz ssserver -C /tmp/ && mv /tmp/ssserver /usr/bin/shadowsocks && rm -f ~/shadowsocks.tar.xz

RUN apk add --no-cache supervisor

RUN wget -O ~/config.conf https://raw.githubusercontent.com/thisdk/accelerator/main/accelerator-kcptube.conf
RUN wget -O ~/supervisord.conf https://raw.githubusercontent.com/thisdk/accelerator/main/accelerator-supervisord.conf
RUN wget -O ~/entrypoint.sh https://raw.githubusercontent.com/thisdk/accelerator/main/accelerator-entrypoint.sh && chmod +x ~/entrypoint.sh

RUN mkdir /etc/supervisor/ && mkdir /etc/supervisor/conf.d/ && mkdir /etc/kcptube/
RUN mv ~/supervisord.conf /etc/supervisor/conf.d/supervisord.conf && mv ~/entrypoint.sh /usr/bin/entrypoint.sh && mv ~/config.conf /etc/kcptube/config.conf

ENTRYPOINT ["/usr/bin/entrypoint.sh"]

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
